#include "shards/math_ops.hpp"

using namespace shards;
using namespace shards::Math;

struct MaxOp final {
  template <typename T> T apply(const T &lhs, const T &rhs) {
    return std::max<T>(lhs, rhs);
  }
};

template <typename TOp> struct ApplyPayloadBinary {
  template <SHType ValueType>
  void apply(SHVarPayload &out, const SHVarPayload &a, const SHVarPayload &b) {
    typename PayloadTraits<ValueType>::Binary binary{};
    binary.template apply<TOp>(getPayloadContents<ValueType>(out),
                      getPayloadContents<ValueType>(a),
                      getPayloadContents<ValueType>(b));
  }
};

int main() {
  SHVarPayload a{};
  a.float4Value[0] = 1.0f;
  a.float4Value[1] = 2.0f;

  SHVarPayload b = a;
  b.float4Value[1] = 0.0f;
  b.float4Value[2] = 3.0f;

  SHType valueType = SHType::Float3;

  SHVarPayload result{};
  dispatchType(valueType, ApplyPayloadBinary<MaxOp>{}, result, a, b);

  return 0;
}

// Tests
// https://godbolt.org/#z:OYLghAFBqd5QCxAYwPYBMCmBRdBLAF1QCcAaPECAMzwBtMA7AQwFtMQByARg9KtQYEAysib0QXACx8BBAKoBnTAAUAHpwAMvAFYTStJg1DIApACYAQuYukl9ZATwDKjdAGFUtAK4sGIMwDMpK4AMngMmAByPgBGmMT%2BktIADqgKhE4MHt6%2B/kGp6Y4CYRHRLHEJZkm2mPZFDEIETMQE2T5%2BgTV1mY3NBCVRsfGJ0gpNLW25nWN9A2UVIwCUtqhexMjsHOYB4cjeWADUJgFuY/iCAHQIx9gmGgCCd/eMPgdCABIAKgCeyZgHIAOXnCBAAHAB9AhHADsVgeBwRBwA9EiDhZaIQmjF6AonoiDpEBJhSHjEQBJQSkfHI1H3A4ANkkMUICgOINJCIpBDMVMRKIOdIAbpgHCQDqgqAczAymSy2YJcfDyYIgvj%2BUKRURiOLJQEDgEzMyCKyQYq6cqCNI1bSDsLRdqJQdJPrDXLTRyDlzQbyEerbZqxY7QQcuPSjSaFR6uaGfX67VqdSH6QdQeH5caPQAxWioJgEWM2xlpqg5vNZ0vc3lxgMOyXSotyku5jNKhHZ5uqmkC/32xN6g3Fitm/HtvNWrsa3uO50DxtDj3ZEgF7vxwOS53AwSgp4maEAEWOcMeDwIv0wWElIMZkLe7y50vB4LzBGIeBiXgImEfUFXxHB6QAL0wCBQ0WMDDyeU8/gvdMDRvD4uT1R9n1fd9P2/CBf3/PAgJA%2BkwMWCCTzPGCQTgqEEMEZ1kIIF83w/L9wR/GtsNw0DwICI8oPPTBL0EUN4LvLcDhoui0MY5j7VY4D2MIzjIJI3j0whCihIIUMRKfWjUIYjCsMAmT8I4rjFMlTcwUEuRo2TUSdPQpjMJYgy8IIojj3ubiYPQVZsX%2BD5R25TSUPo%2BzJK1aSXOMhToKUps81vAKkK0sTdIc/ScMM1z5OImLJTi1SAuo5K7IkxypOc2S3KeMZiC8Bxb0XbVdyPfEvAYTIYRa6kERquqoWaj1uoRcyVIOYg3KG6kRpvYAJsmxFpqhGI5vmoEQVGpgVupXcD2y81usWnsE1skLSvS3DJCyrqER2qr9yqnKeL4ghr1Urk3M8pTvK8XyEorD7TIOGJUE8W8LBB2gAdy2CzEE7AGB8B77l6%2BqPgANWaZQmG%2BUt0E6j02o6gbW2pD5wdB4HPAx7xMCRybKKhEFqa8Wm9vptTpRBMxmdZ67SbUvUyJ5rb8QZ50QUkYW2aGhng3WqW%2BdFtSNJBUMFZ3EmlYCg58vVzXEX8itpXy7mxBZkWDfeRKdYrAI9f2/nCpt5tJbN3mNYd/EUdUxqDjQHNiHt/Fbr2nagu006MLEPBgAidBIrko8d0CXZ9n%2BY5TgILBVA2ZICBuD3mDYBRkiYDYDgUBBmnQBQQBAABZPMEHxh5IMwFhkgMT8jhOAybxCRhgAIa4AmwCuXz6gVkk774LHCZpvjRmsW/NT8O679OTm4ov/k%2BAB5ZIqW31hd5uW1UDwPGmGn2hvggT4jjMelVnzP2BDGA4H/MekmCpNAGA/l/J%2BMRFgr3xPvZI4pkgDXuqHEm/BtQQD7ozHue4DgaEPGyHubgDgDyMMPTBeBrDWEIvrF%2BJgACsc9KFoOOGg1AyQLjXxnhATaVCiEUL3FSZa7CaGJ1JLdVusCk4nnbp3PMm83Bn29lPGec9mDEEXjWDOXAz7E1XmIje2Dj5sE/gfI%2BZ4d6fzPoKC%2BV8b53yAc/D8f935Qisb/N%2BAD7GPzDKA9R4CD5QJgbtPmL9UFQKYRY1h3D%2BFKkEY8YRHsZH3AsfIhevsPEHDXuI7uGcdG730ckwxJ9jGj3PpfA4zDb731cS/WxzjP6uMcf/QBriQFgMRBA7xsIQ5%2BI/BcJqAR6GMOKXfJgnTuGdLCQ7F%2BFxgABIYUElhAzgBDOACM/EYyYiTN6cEgZMQhkgK2mMpgqzpklIGY4mITDFkwgPEI3xHsUlaIzh8H4fw0RMHSMgB5rMx4yKxjjXM6BPjECYHKHxSMbkSOwdIie9Uvm4z%2BQCjMJx7lnjrgFNRrSlReHSEYT%2BZ4AmG2bHNdF4QJnxMUQE2Jcj56KKXvaFRBdpZMA/KgVxwBMCtFkIwY0EB0aY2xrjVxpdvlMHQO42EY0WVrAYAcfluMLi6zdpgiJbS27r1BRncFtVIU8p%2BTClkdyviIpAAFMwKKuoEsxW8nFVsjb4oxUSil3xSVxLtVSrUGcjWjzmvSogTKWUeEEOyhQnL3gY2IFCn5fLNWCuFRYUVBBxWSojegGVRsFbnJ3FE0Ryq0knDVZPUNgrtVwrcAiv4SLbbGtJKaiZ5q6F/Q7NawlaI7UOvJQopR1KTgBFpV1T1jLv7MtZX6hUgbg15rxt/KVPyo0xrjROwVSaOwpoVemjymiVXZvyZ8hNBbcTwr1SWg1FZJDlrRTarFjya24rHPWzFxL7U1rJbfW9zqSAZyPe6ulDLvUDs/EOrlIaE3hoFUKzq07iAStnYm/Krsabyvupcj6q6s1SI3RCqEo7t26reXXd6%2BSkmVrPZvNBDNr22tbc2x9TrlEnFUe%2B7tn6%2B0%2BrZb%2BoN3KgOAdxlO4gYqwPxqAxcJmcrOKpvg3tEFSGc0aqAxh3dWGQD3mPeafD1bum3nk9LfDt7yOz0o%2B2twbrbgfq9Qx79/rh2sd5eOhNnHuPgYTfxwQpsYNCaXVcjNqTJESbQ1u/5OqZP6sQgp4ap7lNEYFiRxtZH72Otbc%2B8aHau2kh7V%2B31P6OV/tHexydIGuOxp4xB%2BzBA7aCejS5hDmaPMofVV5qTPnC3FvYHJqigWgTBexRetSb6TWns01FltC9YuvoS0qJLxmUumfSwByzQHrO5ds3xiWi64ORNcyu8rYLKu5u87CndRa90Na9M1pTbWVOy3Cz1lTD7tMxao24bctHEv0afv2sbzGR2TafhBmbM67Py2K8J5bZX3PrY%2Bahg46Has7fq9h/i9JDutfPSd5WsP1Pdabb1ij13dOhiG%2BaEbT3GODrSyx/9bGpsceyzZ3j0rVb0kWxcgHonEMVZB1VsHW3fO7dk41OHDaQsNU8C%2BlHDbztoMu7e7nhne345M698zYaydZeaqBub0r/YkDp2mlbSqgeYexTzN5Z88f0n7aOl7RO3uk4%2B1Zxp4PtsZ312eM%2BL47fSxy3G53LJxkE9SwGz7d16fa9uX5x5Du/hn1qVCI3JuE1m4DRH28FuLNW%2Bmzb9nhbQ/vOSRDuabueMe%2BNF7mXHKI/glEGMXVif5dPxuBAT7IyFVuaD24DJn8DF/B3hcTvn97jEGADu24DxTGFPwCXPMyAEBvMDea7iVIH6Clnz3vvrjv6d6Yb3hQUaPQKAAO6EHHwcCA3FN/60mmX/4XIQCDVWsr20FwxO0xP/NPpuv904ewEgrOdcEHb%2BrhnT4i/%2B9WF19FhV9E4gYuMmAABrC2bqfkBEM/T0BzS/R/a0akXPCVQUO/JnK/WA1EfEZ/YPfbBzGvM4L/EgH/YgdAP/AAmvZoPvEAzvMAmICA6A6WVaOAv2Z5c/FUZAz2IaDghEdA2/e/HA6kAQopCxF/IgwrEgz/EAb/X/E4f/dfWg4A0AzBZgzAKAmAsQvAzgpQRAy0Xg6/LsfEIQzAkQlAvkPQhEAgznfzJrUeD/dAMg4gCgqgpQmgpwugjfdQoTTQ7Qtg%2BaDghAr0Yw6/cQ8wrA8rUQ1A/AyQwg6HMEWQlw%2BQ8gxQtwZQvvVQ%2Bgvw6NAI1gxWfgvQ0ImHcI9gmwm/Cw7Aqw30SouwqHRrdSZHd/UgtItwjIrIwAnwhgi4JglgnQuI/Q/4AKco4IyoqIywvg3A6kBovbUtPFJwtohQyg6glQ7wtQxgjQgYoIyaEIrgg4Q1MYvYiYynaomI2o0wxEOY2TQ1FI1w9wtY7IjY3IrY/wnYoomY%2BAg4xKY44otAs46I9zWI6w2YhI%2Bw/dRKe49ox4zw9Y9/HovI8ArQwokEuoxEBAwqP4r4xESYmo6Y3QsEmeKQhYq9JYuQlYjwzIrwhEzYvo7YlEnQ/kBAxqbEq4wQwE%2B/CQ4kxIkACXd/UQ8Qr2Ck9I1YuE542k14%2Bk3Y0E/EAonQi8elWgAgNk/EYeYgVAbfceVIl%2BcECUcEf5IwYCcwMwEfUuAgcfSferQiMwMwM5G6JbFzdEneUfcuSuauWuBuJuD2fDF00uN0quSgndI8X0k%2BV0/4d0oMuuRuAhOBR4FOBgPYLwQ4DOZAGqQlAuVuB4GRRuVQLxGgZgWgRpBELk9JHJXRT4TMh2B%2BPpCAePKxWgBABQCpOpb%2BYgJs4/AkoQtolgJgVQP/GvRs5ssaDsraUrOMmJdAdAfM%2BeIspJEspnbRcs0%2Bd1EmGs4Jes1xIclslxNsjs4sgE2bA4Icx%2BaNds4Mj0cckRVbHXLeZcvRaBVc5GUHS7UdHrVFB2Uswgg4DPKs/EIfcxFhCbS3axV%2BePYCpPH%2BEkS4jEuxBPOXQVepTsyaFvW3DnX80eOuTTZkVtIFGUhEHCheIErROwiBGvaPIDWPe3N2A3Jwl%2BZYNEkwkwii3GKik4DChEhimCpi%2BaFin5NitwDiiAEBe0/7RVLM%2B4CCsNTAQUMQKfbFWSmmN5Hc%2BCknXGb%2BIpHcp4KSwVDShpJJHSvGLjBQLwZUvCrqV8hNW9DOe4Kcg%2BExcyj2BETAm4hw7kGvYy0y1%2BY5EZDgs0sfCfM8TCGis8KkSyoDayk4Wy6cx824VpfcKkTy5UqkHyumG/JK/OUOR0h4fkQyg4GSsQAAJV4i4HkseUUpZmUqcQ/jyu/l/ieCFJ4vgLgtquAU7PELyoyrcnEIQSQQyhvDwACQwSE0GozidEIWIUsFIXuEao5JMuVPnTHGFl4U4QCQGSg2WuoVWusCBkWstE2o4RW3EP5Ayr2ug3NioQwW2pU3WsPU2qutoUsF2o2rlUupoW6sqJOswHmoIDOs2tUWurQVupdn%2BpoVPOeruteosABqOs%2BtRFOpepgyoSNUBqKT%2BqhpRsevyPRqRosExo%2BsJIRshtxs7VRuBqWqhtJqxohpBspver2kiMpy6rjOOtRE6u%2Bq8oJtQN6uQSwRrWGujVGpOHGpGsmosGmtZoBJ%2BouDV0DjdguF/EoS2toRuploFzlppgVuURWuppOVlp5i1upR1q5tBKEOZuvMlvZp%2BpNvRNOv1vlq6SBrVoDgNqaier1vVtdptq7Dts9vlomRrQGXts1oDvdudvV39u9q%2BuluDpZguBWUDvDo1rjoTrDtjswHjqjvho5oWvTqYTWqToNr2R2o9pdvls2gZrhvSpzsyqPH5AbxmrZuJwywKtoGKqoDKv%2BAqswCqvAubveygoasqKauasqVarcRXktv7rY3NqHsJprpxouosAeoLsRqXpXpLsXtpjes4SztFWlrXu3uhrBsTsPqVphvBpOTPqoRhr3qJtptxsxtXuJqXqfs3uvrxvprrqrvvoppJpPtVo/qpsvq3qVqprvqZprqRinsr0Qtnpyp/oXrzsVp3pVqduQe1uXpPrTr9s1pQawd3srvnpjtwbjvwYvsTowaNuPu2pwbLrwcwdvqIdQN9vobIcwbftVqoZdWRuwexu4ZfV4cIe/uIa8sLvlvweAcodIYzskb4d2oEfGioXAeYdNsgetpZqrqts5tUdtqQZkc6QLrzrdv4YMbixEZYf0bYYzoDq4YMdDtMesfGQgZIacYTrsbcZAbzuWl0Z9qsYjs1uLo8YCbjuLroZCYzorosbUaPPgcbrEoQfTAOF7PCAgHar0Lys2nithuuNAdQYCS4AuA0CoBNvJv2qhooZUzMCKZKc0ctlgbxncaBpNqvpfqPsqbQQ0BqZabyc/tRoCG6bqY4Pq1tBCoR1C1uLLSIeGent5QyoCVbvbuCqUtCs0qBnr0SY4OSFfEEA7pNOMsBHMAoSoBJDMGOdOeOZNMSoXo/oeuuYPrafPpoWgvid/vKcfr4Wgb0KEIFrnp2g4GWFoE4AoV4D8A4C0FIFQE4CkUsB2oUFWHWHTkCB4FIBVPBYBeWEgJAACHpAuDMFBC4FBA0A0ACAAE4uAAhQRSXJAgggWOBJBQXNBeAoWOBeBa4NBUWmXlg4BYAYAoA%2BWIAkA0AO46B4hyBKBhXkhRWEg9hDBgBIRaoGBIDSAsBBQ8ANg0Y8BMBt8D5GBOAUWaBlT4ha5hKmXSBCLFF9XeBhW2BBA94GBb4zWsBeyjBxB0WVW8AuMHA8BhRa53XMBVARQGIrXyA/U6WIWMRmCEkMBNgIW6IWAuW%2BADA%2B9NXtXdWwWDXZARAxB2ApAZBBBFAVB1B3XdAuB9A5WUAxb9A3xa5YAd4QBKYxhSBhQEhuBoRSWMXIW85Mg/WABaPeAINl2oTUTIFwBgdwTwdoPQUIcIQYcoYYMtgoDIAQSYPwRdtIZdhgOYIYBIMtuwEdgQXoCYSd3IPd4d71w98YfoWd%2BYBd2wK91dvQGYFobd%2Bd3d5YeFtYDYPQH/O1vOCkfgK1wF4Fxl91llg4VQUEekXtxkP2AwTFQ/RVyA0BCAXAQgMUbYLgRYXgNFrQMCUgLFmli4AIEj0jsjsj%2BkfQTgBl0gBN6ELp%2BkUlolihLgal5j1jihUgMFiFlltlkADl3DgF0gHlxAFAVAEV%2BgMgCgOs8TqVyTkAPvZgZISuVAfMVV9VzAVNnV9vENw1z8YgE1mIM1i174ENm19le1x19151uVt1iF/AL1xwX1s1gNoNz8ENkEWoM1yN/5RRDwLAM1%2BNxNksJgFNrV7TvV7gXgfgQQbN8QPNmL%2BQJQNQM13QHkeD4wKtyN2tqAetxt/MFt/V9tzthheoPtgdod7oZwCAVwR9yjmd0oHdkAaEUgJd%2BoOr1rjd%2BoV9hYFr/di9hoB9k9vwSj/r%2BoI969xrt95r%2B9voDr59ybud3rj9hF79st39ggA%2BAgADllngYDjgEFrjs18DyD6D2D4AZAZAA/CeJVlDtDhMTD7Dzl9F/DhALQrABINJgjkAChXF%2Bkf7gHwHwH6QOlmj7j5lzgPjgTrl/bswXgOjhjpjjQFjtj5Hjjo7sDyH57vD4TgVpAF%2BZIGxaTyV6VyIE%2BTgU7mD50WVhDm75D3gc8dD18FwstxLuL3N6QRLwtlLktn9/5ZIIDqjg70DnjzgPeD8QnqER0Sn2DmniZRDtqZDg/DwCT%2BIR%2BAILDnDmH0gN7wVYYL70H%2BH/wUl4jjQVjyQdj1Hyj8HyFrH9l7HztrF%2BkAZ6EQl1j0l%2BkDQKDrgZHyjulwdjH0X1lh3/DuluHwPiH4PwT/Dlt9IZwSQIAA%3D%3D
